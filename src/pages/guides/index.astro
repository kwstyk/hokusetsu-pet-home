---
// src/pages/guides/index.astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { SITE } from '../../config/site';
import { getCollection, type CollectionEntry } from 'astro:content';

type GuideEntry = CollectionEntry<'guides'>;

const pageTitle = `沿線・エリアガイド｜${SITE.name}`;

// 下書きは除外
const guides: GuideEntry[] = await getCollection(
  'guides',
  (entry: GuideEntry) => !entry.data.isDraft,
);

// sortOrder → publishedAt の順で並べ替え
guides.sort((a, b) => {
  const orderDiff =
    (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
  if (orderDiff !== 0) return orderDiff;
  return b.data.publishedAt.getTime() - a.data.publishedAt.getTime();
});

const dateFormatter = new Intl.DateTimeFormat('ja-JP', { dateStyle: 'medium' });
---

<BaseLayout title={pageTitle}>
  <main class="mx-auto max-w-5xl px-4 py-10 sm:px-6 lg:px-8 space-y-8">
    {/* ヘッダー */}
    <section class="space-y-4">
      <h1 class="text-2xl md:text-3xl font-bold text-slate-900">
        沿線・エリアガイド
      </h1>
      <p class="text-sm md:text-base text-slate-700 leading-relaxed">
        北摂エリアの「沿線ごとのざっくりした雰囲気」を整理していくためのコーナーです。
        物件を探し始める前に、まずはエリアのイメージを掴むための読みものとして育てていく予定です。
      </p>
      <p class="text-xs text-slate-500">
        いまはサンプル記事のみ掲載しています。実運用を開始したら、阪急・JR・北大阪急行などの沿線ごとに
        少しずつ追加していく想定です。
      </p>
    </section>

    {/* 一覧 */}
    <section class="space-y-4">
      {guides.length === 0 ? (
        <p class="text-sm text-slate-600">
          まだ公開中の沿線ガイドはありません。準備が整い次第、こちらに記事を追加していきます。
        </p>
      ) : (
        <ul class="space-y-4">
          {guides.map((guide: GuideEntry) => (
            <li class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
              <article class="space-y-2">
                <header class="space-y-1">
                  <p class="text-[11px] text-slate-500">
                    公開日：{dateFormatter.format(guide.data.publishedAt)}
                  </p>
                  <h2 class="text-base md:text-lg font-semibold text-slate-900">
                    <a
                      href={`/guides/${guide.slug}/`}
                      class="hover:underline"
                    >
                      {guide.data.title}
                    </a>
                  </h2>

                  {(guide.data.line || guide.data.areaName) && (
                    <p class="text-[11px] text-slate-500">
                      {guide.data.line && <span>{guide.data.line}</span>}
                      {guide.data.line && guide.data.areaName && '｜'}
                      {guide.data.areaName && (
                        <span>{guide.data.areaName}</span>
                      )}
                    </p>
                  )}

                  {guide.data.description && (
                    <p class="text-sm text-slate-700 leading-relaxed">
                      {guide.data.description}
                    </p>
                  )}
                </header>

                {guide.data.tags && guide.data.tags.length > 0 && (
                  <div class="flex flex-wrap gap-2 pt-1 text-[11px]">
                    {guide.data.tags.map((tag: string) => (
                      <span class="rounded-full bg-slate-100 px-2 py-0.5 text-slate-700">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}

                <div class="pt-2">
                  <a
                    href={`/guides/${guide.slug}/`}
                    class="inline-flex items-center text-xs font-semibold text-emerald-700 hover:underline"
                  >
                    ガイドを読む
                  </a>
                </div>
              </article>
            </li>
          ))}
        </ul>
      )}
    </section>
  </main>
</BaseLayout>
